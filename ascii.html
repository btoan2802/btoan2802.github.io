<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>by Btoanüòº</title>
  <style>
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
      text-align: center;
      overflow: hidden; /* output will scroll inside container */
    }

    /* full-screen output (default) */
    #asciiContainer {
      position: fixed;
      inset: 0;
      overflow: auto;
      padding: 12px;
      -webkit-overflow-scrolling: touch;
    }

    .ascii-art {
      white-space: pre;
      font-family: monospace;
      font-size: 5px;
      line-height: 4px;
    }

    canvas { display: none; }

    /* small + menu (like AI) */
    .fab {
      position: fixed;
      right: 14px;
      bottom: 14px;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: #fff;
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
    }
    .fab:active { transform: translateY(1px); }

    .menu {
      position: fixed;
      right: 14px;
      bottom: 66px;
      display: none;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(10,10,10,.72);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .menu.show { display: flex; }

    .menu button {
      all: unset;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: #fff;
      font-size: 12px;
      line-height: 1;
      user-select: none;
      min-width: 120px;
    }
    .menu button:active { transform: translateY(1px); }
    .menu svg { width: 16px; height: 16px; }

    /* tiny hint (optional) */
    .hint {
      position: fixed;
      left: 10px;
      bottom: 10px;
      font-size: 11px;
      color: rgba(255,255,255,.55);
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      padding: 6px 8px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      pointer-events: none;
    }

    @media (max-width: 480px) {
      .menu button { min-width: 110px; }
    }
  </style>
</head>
<body>
  <div id="asciiContainer" class="ascii-art"></div>
  <canvas id="canvas"></canvas>

  <!-- hidden pickers -->
  <input id="fileImg" type="file" accept="image/*" hidden />
  <input id="fileCam" type="file" accept="image/*" capture="environment" hidden />

  <!-- small + button + menu -->
  <div id="plusFab" class="fab" aria-label="menu">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>

  <div id="plusMenu" class="menu" role="menu" aria-label="attach">
    <button id="pickGallery" type="button" role="menuitem">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 6.5A2.5 2.5 0 0 1 6.5 4h11A2.5 2.5 0 0 1 20 6.5v11A2.5 2.5 0 0 1 17.5 20h-11A2.5 2.5 0 0 1 4 17.5v-11Z" stroke="currentColor" stroke-width="2"/>
        <path d="M8.5 11.2 6 14.2V17.5c0 .55.45 1 1 1h10c.55 0 1-.45 1-1v-2.1l-3.1-3.6a1 1 0 0 0-1.5-.02l-2.1 2.4-1.4-1.7a1 1 0 0 0-1.5-.03Z" fill="currentColor" opacity=".25"/>
        <path d="M9 9a1.2 1.2 0 1 0 0-2.4A1.2 1.2 0 0 0 9 9Z" fill="currentColor"/>
      </svg>
      ch·ªçn ·∫£nh
    </button>

    <button id="pickCamera" type="button" role="menuitem">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.5 7.5 9 5.5h6l1.5 2H19a2 2 0 0 1 2 2V18a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9.5a2 2 0 0 1 2-2h2.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M12 17a3.2 3.2 0 1 0 0-6.4A3.2 3.2 0 0 0 12 17Z" stroke="currentColor" stroke-width="2"/>
        <path d="M17.2 10.2h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
      </svg>
      camera
    </button>
  </div>

  <div class="hint">b·∫•m <b>+</b> ƒë·ªÉ ch·ªçn/ch·ª•p ·∫£nh ‚Ä¢ ho·∫∑c d√°n ·∫£nh (Ctrl+V)</div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const asciiContainer = document.getElementById('asciiContainer');

    const fileImg = document.getElementById('fileImg');
    const fileCam = document.getElementById('fileCam');

    const plusFab = document.getElementById('plusFab');
    const plusMenu = document.getElementById('plusMenu');
    const pickGallery = document.getElementById('pickGallery');
    const pickCamera = document.getElementById('pickCamera');

    // keep width like your original web
    const ASCII_WIDTH = 350;

    // b·ªô k√Ω t·ª± cho ASCII art (gi·ªØ nguy√™n nh∆∞ b·∫°n g·ª≠i)
    const grayScaleChars = [".", ":", "U", "u", "A", "a", "o", "i", "l", "=", "*", "#", "%", "@"]; 

    let lastObjectUrl = "";

    function openMenu(show){
      if (show) plusMenu.classList.add('show');
      else plusMenu.classList.remove('show');
    }

    plusFab.addEventListener('click', () => {
      openMenu(!plusMenu.classList.contains('show'));
    });

    // close menu when clicking outside
    window.addEventListener('click', (e) => {
      if (!plusMenu.classList.contains('show')) return;
      const target = e.target;
      if (target === plusFab || plusFab.contains(target)) return;
      if (target === plusMenu || plusMenu.contains(target)) return;
      openMenu(false);
    });

    // open pickers
    pickGallery.addEventListener('click', () => {
      openMenu(false);
      fileImg.value = '';
      fileImg.click();
    });

    pickCamera.addEventListener('click', () => {
      openMenu(false);
      fileCam.value = '';
      fileCam.click();
    });

    function fileToImage(file){
      return new Promise((resolve, reject) => {
        if (lastObjectUrl) {
          try { URL.revokeObjectURL(lastObjectUrl); } catch {}
          lastObjectUrl = "";
        }
        const url = URL.createObjectURL(file);
        lastObjectUrl = url;

        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('kh√¥ng ƒë·ªçc ƒë∆∞·ª£c ·∫£nh'));
        img.src = url;
      });
    }

    function convertToAscii(imageData){
      let ascii = '';
      const data = imageData.data;

      for (let y = 0; y < imageData.height; y++) {
        for (let x = 0; x < imageData.width; x++) {
          const index = (y * imageData.width + x) * 4;
          const r = data[index];
          const g = data[index + 1];
          const b = data[index + 2];

          const brightness = (r + g + b) / 3;
          const charIndex = Math.floor((brightness / 255) * (grayScaleChars.length - 1));
          const ch = grayScaleChars[charIndex];

          ascii += `<span style="color: rgb(${r}, ${g}, ${b})">${ch}</span>`;
        }
        ascii += '<br>';
      }

      return ascii;
    }

    async function renderFile(file){
      if (!file) return;
      if (!String(file.type || '').toLowerCase().startsWith('image/')) return;

      // no preview: just render output
      asciiContainer.innerHTML = '';

      const img = await fileToImage(file);
      const width = ASCII_WIDTH;
      const height = Math.max(1, Math.round((img.height / img.width) * width));

      canvas.width = width;
      canvas.height = height;
      ctx.clearRect(0, 0, width, height);
      ctx.drawImage(img, 0, 0, width, height);

      const imageData = ctx.getImageData(0, 0, width, height);
      asciiContainer.innerHTML = convertToAscii(imageData);
    }

    fileImg.addEventListener('change', () => {
      const f = fileImg.files && fileImg.files[0];
      renderFile(f).catch((e) => {
        alert('l·ªói: ' + (e?.message || e));
      });
    });

    fileCam.addEventListener('change', () => {
      const f = fileCam.files && fileCam.files[0];
      renderFile(f).catch((e) => {
        alert('l·ªói: ' + (e?.message || e));
      });
    });

    // paste image (Ctrl+V)
    window.addEventListener('paste', (e) => {
      const items = e.clipboardData?.items || [];
      for (const it of items) {
        if (it.kind === 'file' && String(it.type || '').startsWith('image/')) {
          const f = it.getAsFile();
          if (f) {
            renderFile(f).catch(() => {});
            return;
          }
        }
      }
    });

    // initial message
    asciiContainer.innerHTML = '<div style="opacity:.6; font-size:14px; padding: 18px;">b·∫•m <b>+</b> ƒë·ªÉ ch·ªçn/ch·ª•p ·∫£nh</div>';
  </script>
</body>
</html>
